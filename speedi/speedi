#!/opt/homebrew/bin/bash

# =============================================================================
# üöÄ Speedi - –¢–µ—Å—Ç–µ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
# =============================================================================
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏–∑–º–µ—Ä—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è:
# - –°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ (download)
# - –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ (upload)
#
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ä–≤–∏—Å speed.cloudflare.com –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤.
# –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –º–µ–≥–∞–±–∏—Ç–∞—Ö –≤ —Å–µ–∫—É–Ω–¥—É (Mbit/s).
#
# –ê–≤—Ç–æ—Ä: –í–ª–∞–¥–∏–º–∏—Ä –ë—ã—á–∫–æ, Chat GPT, SourseCraft Code Assistant
# –î–∞—Ç–∞: 2025
# =============================================================================

# –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Å—Ç—Ä–æ–≥–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
# –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

# =============================================================================
# üîß –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
# =============================================================================

# URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ (10 –ú–ë —Ñ–∞–π–ª)
readonly DOWNLOAD_URL="https://speed.cloudflare.com/__down?bytes=10000000"

# URL –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
readonly UPLOAD_URL="https://speed.cloudflare.com/__up"

# –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–≤ –º–µ–≥–∞–±–∞–π—Ç–∞—Ö)
readonly UPLOAD_SIZE_MB=10

# =============================================================================
# üì¶ –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# =============================================================================

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —É—Ç–∏–ª–∏—Ç –≤ —Å–∏—Å—Ç–µ–º–µ
check_dependencies() {
    local missing_tools=()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º curl
    if ! command -v curl &>/dev/null; then
        missing_tools+=("curl")
    fi

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º bc
    if ! command -v bc &>/dev/null; then
        missing_tools+=("bc")
    fi

    # –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –≤—ã–≤–æ–¥–∏–º –æ—à–∏–±–∫—É –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
    if [ ${#missing_tools[@]} -ne 0 ]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: ${missing_tools[*]}"
        echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏—Ö –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
        exit 1
    fi
}


# =============================================================================
# üåê –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
# =============================================================================

# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Å–µ—Ä–≤–∏—Å speed.cloudflare.com
check_internet_connection() {
    echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É..."

    # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç speed.cloudflare.com
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–π–º–∞—É—Ç 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
    if ! curl --silent --fail --max-time 10 --head "https://speed.cloudflare.com" &>/dev/null; then
        echo "‚ùå –°–µ—Ä–≤–∏—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–∞ –∫–æ–º—å—é—Ç–µ—Ä–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç"
        exit 1
    fi

    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
}

# =============================================================================
# üìä –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
# =============================================================================

# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∏–∑ –±–∞–π—Ç–æ–≤/—Å–µ–∫ –≤ –º–µ–≥–∞–±–∏—Ç—ã/—Å–µ–∫
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –±–∞–π—Ç–∞—Ö/—Å–µ–∫
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
#   —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –º–µ–≥–∞–±–∏—Ç–∞—Ö/—Å–µ–∫
convert_to_mbps() {
    local bytes_per_sec=$1

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if [[ -z "$bytes_per_sec" || "$bytes_per_sec" == "0" ]]; then
        echo "0"
        return
    fi

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –±–∞–π—Ç—ã –≤ —Å–µ–∫—É–Ω–¥—É –≤ –º–µ–≥–∞–±–∏—Ç—ã –≤ —Å–µ–∫—É–Ω–¥—É
    # 1 –±–∞–π—Ç = 8 –±–∏—Ç, 1 –ú–±–∏—Ç = 1000000 –±–∏—Ç
    echo "$bytes_per_sec*8/1000000" | bc -l
}

# –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ –≤—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - —Ç–∏–ø —Ç–µ—Å—Ç–∞ (–∑–∞–≥—Ä—É–∑–∫–∞/–æ—Ç–ø—Ä–∞–≤–∫–∞)
#   $2 - —Å–∫–æ—Ä–æ—Å—Ç—å –≤ –º–µ–≥–∞–±–∏—Ç–∞—Ö/—Å–µ–∫
print_speed_result() {
    local test_type=$1
    local mbps=$2

    # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
    awk -v test_type="$test_type" -v mbps="$mbps" 'BEGIN {
        printf "‚öôÔ∏è  %-15s: %8.2f Mbit/s\n", test_type, mbps
    }'
}

# =============================================================================
# üìà –§—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
# =============================================================================

# –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
test_download_speed() {
    echo "‚¨áÔ∏è  –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏..."

    # –ò–∑–º–µ—Ä—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –±–∞–π—Ç–∞—Ö –≤ —Å–µ–∫—É–Ω–¥—É
    local bytes_per_sec
    bytes_per_sec=$(curl -L --silent --output /dev/null --write-out "%{speed_download}\n" "$DOWNLOAD_URL")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if [[ -z "$bytes_per_sec" || "$bytes_per_sec" == "0" ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏"
        return 1
    fi

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏ –≤—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    local mbps
    mbps=$(convert_to_mbps "$bytes_per_sec")
    print_speed_result "–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏" "$mbps"
}

# –¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
test_upload_speed() {
    echo "‚¨ÜÔ∏è  –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏..."

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º /dev/zero –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∑–∞–ø–∏—Å–∏ –Ω–∞ –¥–∏—Å–∫
    local bytes_per_sec
    bytes_per_sec=$(dd if=/dev/zero bs=1M count=$UPLOAD_SIZE_MB 2>/dev/null | \
        curl -X POST --silent --output /dev/null --write-out "%{speed_upload}\n" \
        -H "Content-Type: application/octet-stream" \
        --data-binary @- "$UPLOAD_URL")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    if [[ -z "$bytes_per_sec" || "$bytes_per_sec" == "0" ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏"
        return 1
    fi

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏ –≤—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    local mbps
    mbps=$(convert_to_mbps "$bytes_per_sec")
    print_speed_result "–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏" "$mbps"
}

# =============================================================================
# üéõÔ∏è –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É
# =============================================================================

# –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø—Ä–∞–≤–∫—É –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å–∫—Ä–∏–ø—Ç–∞
show_help() {
    echo "üöÄ Speedi - –¢–µ—Å—Ç–µ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  speedi          # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏"
    echo "  speedi --help   # –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–û–ø–∏—Å–∞–Ω–∏–µ:"
    echo "  –°–∫—Ä–∏–ø—Ç –∏–∑–º–µ—Ä—è–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—è —Å–µ—Ä–≤–∏—Å"
    echo "  speed.cloudflare.com. –¢–µ—Å—Ç –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –∏–∑–º–µ—Ä–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏"
    echo "  –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö."
    echo ""
    echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
    echo "  –°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –º–µ–≥–∞–±–∏—Ç–∞—Ö –≤ —Å–µ–∫—É–Ω–¥—É (Mbit/s)."
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∫—Ä–∏–ø—Ç–∞
main() {
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    case "${1:-}" in
        --help|-h|help)
            show_help
            exit 0
            ;;
        "")
            # –ù–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ - –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
            ;;
        *)
            echo "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: $1"
            echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ --help –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏."
            exit 1
            ;;
    esac

    # –í—ã–≤–æ–¥–∏–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    echo "üöÄ Speedi - –¢–µ—Å—Ç–µ—Ä —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
    echo "================================================"
    echo ""

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
    check_internet_connection

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
    check_dependencies

    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
    test_download_speed
    echo ""
    test_upload_speed

    # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–∞–±–æ—Ç—É
    echo ""
    echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
}

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ —Å–∫—Ä–∏–ø—Ç
main "$@"